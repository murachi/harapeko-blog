<h1>会社サーバーを立てるまで。(前編)</h1>

<div class="entry">
<p>とりあえず、このサーバーを立てる (建てる? どっちの方が正しいんだろう?) に際して行った作業や費用などについて、ここでまとめておこうかと思います。今回は、サーバーのレンタルと、ドメインの取得および設定についてです。<br/>
<span id="more-7"></span></p>
<h3>サーバーを借りる</h3>
<p>今回借りたのは、<a href="http://www.fsv.jp/" title="レンタルサーバーのファーストサーバ">ファーストサーバ</a>さんとこの、<a href="http://www.senyu.jp/dt/" title="専用サーバー（セルフマネージド）「デルタ１・シリーズ」/ファーストサーバ">デルタ1・シリーズ</a>というやつです。このサービスは、ソフトバンクIDC のデータセンターに置かれたそこそこのスペックのマシン (Celeron420 1.6GHz / 512MB RAM / 80GB HDD) をまるまる一台自由に使わせてもらえるというものです。但し、マシンは CentOS (後になって FreeBSD のコースもできたようですが) をインストールしただけの (そして ssh 以外のサービスを一通り停止させた) 状態で納品され、設定用の特別なツール (Web から操作できるコントロールパネルとか) や、監視などの各種サービスはなく、設定も管理もすべてお客さんの方でやってね、という非常に漢 (おとこ) らしいサービスです。</p>
<p>価格は、初期費用 (入会金のようなもの、恐らくは設備投資費) が 36,750円、月額費用が 6,510円。ノーメンテなだけあって、国内の専用サーバーレンタルサービスとしては非常にリーズナブルです。契約では支払い単位を半年とさせていただいたので、初回の請求金額は <strong>75,810円</strong>となりました (次回以降は月額費用のみなので、39,060円を半年ごとに納めることになります)。</p>
<p>さて、私が申し込んだのは 4月の半ば頃で、オンラインお申し込みのページには <q>ご提供まで2週間程度のお時間を…</q> などと書かれていたのですが、実際には申し込みをした2日後には設定完了の報告書が請求書とともに送られてきました。これはうれしい誤算!! まだドメイン名すらなく、IP アドレスだけで ssh からログインできますよーというだけの状態だったのですが、早速中を覗いてみたり、とりあえず惰性で apache を動かしてみたりしました。</p>
<h3>ドメインの移転</h3>
<p>ここでサーバーの設定の話に入ってもいいのですが、その前に、ドメインの取得と設定について書いた方が、話の流れ的には正しいような気がするので、そうしておこうと思います。</p>
<p>私の場合、 harapeko.jp ドメインは以前から持っていたのですが (いわゆる「ホームページ」を作るために予約していたまま、ほとんど使わずに放置していました)、当時の管理業者であった ISP が提供するサーバーでしか使わせてもらえないというものだったので、他のレジストラに変更する必要がありました。同じファーストサーバさんの <a href="http://do-reg.jp/" title="『Ｄｏレジ』　ドメイン名の取得から高度な活用まで　安心と信頼のレジストラ">Doレジ</a>を利用するという手もあったのですが、今後のフットワークも考慮して、<a href="http://jprs.jp/">JPRS</a> 自体が提供するドメイン名登録管理サービスである <a href="http://jpdirect.jp/">JPDirect</a> を利用させていただくことにしました。</p>
<h4>ISPとの契約を解約する</h4>
<p>まずは JPDirect に申し込む前に、これまでドメイン名を管理してもらっていた ISP との、ドメイン名に関する契約を解約しなければなりません (接続契約まで切る必要はないですよ、念のため)。私の場合は、これはオンラインではなく、申込書を FAX するという手続きでした。</p>
<p>注意点が一つだけあって、ドメイン名を「廃止」するのか、他のサーバーに「移行」するのかを聞かれますので、これは必ず「移行」にしなければなりません。誤って廃止してしまうと、同じドメインは 1ヶ月間利用 (というか取得) できなくなってしまうので注意しましょう。</p>
<h4>移転を申し込む</h4>
<p>ドメイン名を whois で調べると<a href="http://whois.jprs.jp/?codecheck-sjis=%82%C9%82%D9%82%F1%82%EA%82%B6%82%B7%82%C6%82%E8%82%B3%81%5B%82%D1%82%B7&amp;type=dom&amp;key=HARAPEKO.JP" title="JP WHOIS /JPRS">こんな感じで表示される</a>のですが、このときの「登録者名」が元々個人名義だったのを、会社名義に変更したかったので、<a href="https://apply.rs.jprs.jp/agentchange.php?m=agentchange">指定事業者変更WEB</a>で登録者情報を会社の名前にしてみたところ、JPDirect さんから電話がかかってきて、「登録者名を変更したい場合は [移転] という扱いになるので、申し込み方法が異なります」とのご説明をいただきました。指定事業者変更であれば料金は無料だったのですが、移転の場合は有料 (3,885円) になるみたいです。なるほど。</p>
<p>移転申請の場合は、JPDirect に登録 ID を持っていないうちは、本来であれば<a href="http://jpdirect.jp/general/transfer/index.html#03" title="指定事業者変更とドメイン名の移転 - JPDirect">メールにて問い合わせる必要がある</a>のですが、私の場合は先ほどのお電話口にて移転手続きに関するご案内メールを送っていただけるという話になったので、そのメールの案内に従って、移転手続きの Web ページにて必要事項を入力する、という形になりました。</p>
<h4>DNS を立てる</h4>
<p>レジストラの仕事はドメインの管理だけなので、登録したドメインを使用するホストの IP と結びつけるには、自分で DNS を立てる必要があります。DNS には <a href="http://www.isc.org/index.pl?/sw/bind/index.php" title="Internet Systems Consortium, Inc.">BIND</a> というのを使用します。これはデルタ1・シリーズのサーバーには最初からインストールされていました。</p>
<p>BIND は chroot 環境で動作するよう設定されていたので、設定ファイルの類はすべて <code>/var/named/chroot</code> ディレクトリの配下に置く必要があります。まずは <code>/var/named/chroot/etc/named.conf</code> を以下のような内容で作成し、</p>
<pre>options {
        directory "/var/named";
};
zone "." {
        type hint;
        file "named.root";
};
zone "localhost" {
        type master;
        file "localhost.zone";
        allow-update { none; };
};
zone "0.0.127.in-addr.arpa" {
        type master;
        file "localhost.rev";
        allow-update { none; };
};
zone "harapeko.jp" {
        type master;
        file "harapeko.jp.zone";
};
zone "21.237.218.202.in-addr.arpa" IN {
        type master;
        file "harapeko.jp.rev";
};</pre>
<p>さらに、<code>/var/named/chroot/var/named</code> ディレクトリ下に、正引きおよび逆引きのゾーンファイル <code>localhost.zone</code>、<code>localhost.rev</code>、<code>harapeko.jp.zone</code>、<code>harapeko.jp.rev</code> をそれぞれ作成しました。</p>
<p>BIND の設定に関しては、以下のサイトを参考にさせていただきました(敬称略)。感謝!!</p>
<ul>
<li><a href="http://www.fc-lab.com/network/server/dns/bind.html">FC Lab – BINDの設定</a></li>
<li><a href="http://www.atmarkit.co.jp/flinux/rensai/bind02/bind02.html">@IT – BINDで作るDNSサーバ　第2回　名前解決の仕組みとゾーンファイルの設定</a></li>
<li><a href="http://park1.wakwak.com/~ima/centos4_bind0001.html">ごった煮 – CentOS 4.0導入記(覚え書き) – DNSサーバ(bind9)の導入</a></li>
</ul>
<p>設定ファイルを書き終わったら、後は BIND を起動すれば ok です。ついでに <code>chkconfig</code> コマンドでデーモンの自動起動の設定もしておきましょう。</p>
<pre>% su -
% /etc/init.d/named start
% chkconfig named on    # あるいは ntsysv コマンドによる UI で選択しても ok</pre>
<h4>ネームサーバーの登録</h4>
<p>私はこれを勘違いしていたために無駄に時間を食ってしまったのですが、取得したドメインが実際に運用に乗るためには、取得して DNS を立てる、だけでは駄目で、世界中の DNS が登録したドメインをたどって自分の DNS にたどり着くことができるように、レジストラに DNS があるホストマシンの場所を登録しておかなければなりません。</p>
<p>JPDirect で登録した場合、それは<a href="https://apply.rs.jprs.jp/service.php">登録者ログイン</a>のページから入って行うのですが、それまでのメールや書簡での案内にはこのページについては触れられておらず、そういう設定が必要だという説明も<a href="http://jpdirect.jp/faq/h_2000_index.html" title="汎用 ネームサーバ設定編 - JPDirect">Q&amp;ampA のページに埋もれているだけ</a>だったりするので、名前解決の仕組みに関する十分な知識がない人はなかなか気づけないかもしれません (っていうか気づきませんでした、お恥ずかしい)。しかもここで入力する登録者番号やパスワードは、書簡で送られてきた請求書の片割れの隅っこにひっそりと小さく書いてあるだけなので、知らないと捨ててしまって紛失してしまっているかもしれません (っていうか紛失しかけました…)。注意しましょう。</p>
<p>ここで行うべき設定は以下の通りです。</p>
<ul>
<li>ネームサーバ設定／解除指定事業者変更や移転の場合は、移行前の事業者が設定していたネームサーバーの設定が残っています。これをそのまま自分のホスト名に変更して登録…できればいいのですが、私がやったときはそれではうまくいきませんでした。いったん前の設定を「解除」してから、新たに設定し直す、という手順を踏む必要があるようです。登録するのはホスト名なのですが、もしかしたら IP アドレスでもいいのかもしれません。私は念のため、 <code>hostname</code> コマンドが返す名前を指定しておくことにしました。</li>
<li>ホスト情報新規登録DNS の設定で、ネームサーバー用に設定したホスト名と、ホストの IP アドレスを結びつける設定を行います。これはもしかしたら不要なのかもしれません。あるいはネームサーバー設定で指定すべきホスト名をここで定義できる、というだけの話なのかもしれません…。</li>
</ul>
<p>設定が完了すると、行った設定ごとに JPDirect からメールが送られてきます。実際に設定が反映されるまでにはそれなりに時間がかかります (夜のうちに設定すれば、一晩たてば翌朝には使えるようになる、ぐらいの感覚です)。</p>
<p>今回はここまで。次回は DNS 以外の設定に関するメモを公開します。</p>
<p><small>2008 年 5 月 7 日 by 村山 俊之</small></p>


</div>

<p>(転載元: はらぺこ日誌 〜株式会社はらぺこ 公式ブログ〜)</p>
