[author: murachi]
# 開発の手引き

## 必要な環境のセットアップ

### Subversion

プログラム・ソースは会社サーバー上に Subversion リポジトリとして管理しています。ここからソースを引っ張り出し (checkout)、作成・変更したものを up し (commit)、他の誰かが加えた変更を手元のファイルに反映する (update) ということをやるためのクライアントツールが必要です。

多くの Unix 風環境では最初から入っているか、ディストリビューションが提供するセントラルリポジトリからインストールが可能なはずです。 Mac OS X は 10.5 以降であれば、 Developper Tools を導入済みであれば入っています。 Subversion が導入済みであることを確認するには、ターミナル上で以下のコマンドを入力してみてください。

```
$ svn --version
```

Windows の場合は、 [Cygwin](http:://www.cygwin.com/) を導入するか、または [TortoiseSVN](http:://tortoisesvn.tigris.org/) をインストールしてください。

### MTASC

Action Script 2.0 コンパイラです。セットアップ方法は [Idea Note にまとめてある](http:://developer.harapeko.jp/trac/original/ideanote/wiki/HowTo/MtascTutorial)ので、そちらを参照してください。

### swfmill

XML と Flash (SWF) ファイルとを相互変換するツールです。 Flash に画像などのリソースを埋め込むために利用します。

* [swfmill swf2xml and xml2swf](http:://swfmill.org/)

Windows および Mac OS X では、 "Download swfmill" から書庫ファイルをダウンロードし、展開したディレクトリ下のファイル swfmill(.exe) を、パスの通ったディレクトリ (%windir%\system32 や /usr/local/bin など) にコピーしてください。 Linux やその他の Unix 風環境でも同様ですが、ディストリビューションによってはセントラルリポジトリからでもインストールできるでしょう。

### Perl CPAN ライブラリ

多くの Unix 風環境 (Mac OS X 含む) においては、 Perl 自体は導入済みであるはずです。 Windows の場合は、 [ActivePerl](http:://www.activestate.com/activeperl) をインストールしておいてください。

本プロジェクトでは、ビルド時に実行する Perl スクリプトにおいて、デフォルトでは導入されないいくつかのライブラリを利用しています。それらは CPAN と呼ばれる Perl ライブラリのセントラルリポジトリにおいて配布されているものです。インストールされている必要があるライブラリは以下の通りです。

* [XML::Smart](http:://search.cpan.org/~gmpassos/XML-Smart-1.6.9/lib/XML/Smart.pm)
* [MIME::Base64](http:://search.cpan.org/~gaas/MIME-Base64-3.13/Base64.pm)
* [Compress::Zlib](http:://search.cpan.org/~pmqs/IO-Compress-2.030/lib/Compress/Zlib.pm)
* [Getopt::Compact](http:://search.cpan.org/~asw/Getopt-Compact-0.04/lib/Getopt/Compact.pm)

Windows で ActivePerl を使用する場合、 CPAN ライブラリは Perl Package Manager というツールを用いてインストールします。このツールは GUI でも動作しますが (スタートメニューから起動できます)、コマンドプロンプトから ppm コマンドを用いてインストールしてしまった方が手っ取り早いかも知れません。

```
> ppm install XML-Smart
> ppm install MIME-Base64
> ppm install IO-Compress
> ppm install Getopt-Compact
```

Mac OS X や Linux 、その他の UNIX 風環境においては、 cpan コマンドを用いてインストールを行ってください。途中でいろいろ聞かれるかも知れませんが、とりあえず Enter キーを押しておけば何とかなりそうです。

```
$ sudo cpan -i XML::Smart
$ sudo cpan -i MIME::Base64
$ sudo cpan -i Compress::Zlib
$ sudo cpan -i Getopt::Compact
```

## チェックアウトからビルドまで

それでは、ソースをチェックアウトし、 Flash アプリをビルドしましょう。

### チェックアウト

まず、チェックアウトは以下のコマンドにて行います。

```
$ svn co svn+ssh://onaka.harapeko.jp/var/Developer/svn/original/boeboe
```

カレントディレクトリに boeboe ディレクトリが生成され、その配下に Subversion リポジトリに格納されている全てのファイルがコピーされます。

Windows で TortoiseSVN を用いる場合は、エクスプローラにて任意のディレクトリを開き、右クリック→「SVN Checkout...」を選択して、表示される Checkout ダイアログの「URL of repository:」欄に「svn+ssh:// *userid* @onaka.harapeko.jp/var/Developer/svn/original/boeboe」と入力して「OK」ボタンを押すと、チェックアウトが開始されます。なお、 *userid* には、あなたのサーバー上でのアカウント ID を入力してください。

### ファイル構成

チェックアウトしたソースファイルのファイル構成は以下のようになっています。

* boeboe/
  * branch/
  * tag/
  * trunk/
    * proto/
      * プロトタイプのファイルたち...
    * src/
      * boeboe/
        * ぼえぼえ～ for Flash Lite ソースファイル...
        * resource/
          * 画像ファイルとか... (あとで場所変えるかも…)
      * mixi-mobile/
        * mixi 版関連のソースファイルが入る予定…。

trank 以下が**メイントランク**です。最新版の開発は常にこの配下で行います。なお、製品版のリリースに先駆けて**ブランチ**を分けることがあります。その場合、 branch 以下にメジャーバージョンごとにディレクトリを作って、その時々のメイントランクの内容をコピーします。さらに、実際にリリースしたときのバージョンのコピーを**タグ**として、tag 以下にバージョンごとにディレクトリを作り、コピーしていきます。

src 以下が実際に開発するプログラムのソースを格納する場所です。特に、その下の boeboe 以下では Flash Lite 版ぼえぼえ～本体のプログラム等が格納されることになります。

### ぼえぼえ～ for Flash Lite をビルド

ぼえぼえ～ for Flash Lite をビルドするには、ターミナル上で、ぼえぼえ～ for Flash Lite のソースディレクトリに移動し、 Perl で書かれたビルドスクリプトを実行すれば ok です。

```
$ cd boeboe/trunk/src/boeboe
$ perl build.pl
```

エラーメッセージ等が一切表示されずに、カレントディレクトリ下に boe.swf ファイルが生成されていれば、ビルド成功です。

## 実際の開発の進め方

### ファイルの編集とコミット

どのファイルも、テキストエディタ等で変更を加えたら、その変更内容をサーバー上の Subversoin リポジトリに反映する必要があります。この操作のことを**コミット (commit)** と言います。コミットを行うには、ターミナル上で、以下のコマンドを実行します。

```
$ svn commit ファイル名
```

すると、 ViM などのテキストエディタが起動し、コミットログを編集できる状態になりますので、そのファイルの先頭にコメントを記述してから保存し、テキストエディタを終了して下さい。なお、コミットをキャンセルしたい場合は、ファイルの内容をすべて消去してから保存して終了すると、キャンセルになります。

コメントの書き方ですが、チケットへの対応の場合、チケットの番号と、変更点の説明を記述して下さい。例えばチケットの 12 番への対応の場合、以下のように記述します。

```
#12 への対応:
 * ゲーム開始時にブロックを生成し表示する処理を実装。
 * ゲーム開始時のプレイヤーの表示位置が中途半端だったのを調整した。
```

コミットログは Trac からも参照できるようになっています。上記のように記述した場合、以下のように表示されるでしょう。

> \#12 への対応:
> * ゲーム開始時にブロックを生成し表示する処理を実装。
> * ゲーム開始時のプレイヤーの表示位置が中途半端だったのを調整した。

コミットが完了すると、リビジョン番号が表示されるので、この番号を対応するチケットにコメントとして投稿して下さい。例えば、リビジョン番号が 57 番だった場合、以下のように記述します。

```
[57] ... ブロックの生成と表示に対応。プレイヤーのデフォルト表示位置を調整。
```

投稿されたコメントは以下のように表示されるはずです。

> [57] ... ブロックの生成と表示に対応。プレイヤーのデフォルト表示位置を調整。


なお、複数のファイルを一度にコミットしたい場合は、それらのファイルが存在するディレクトリをファイル名として指定すれば ok です。変更を加えたファイルのみが自動で選択され、それらを一度にコミットすることができます。変更を加えたファイルがサブディレクトリ下にある場合でも、それらもすべて探し出してコミットしてくれます。

```
# カレントディレクトリ下のファイルを一括してコミットする場合
$ svn commit .
```

### 手元のファイルを最新の状態に更新する

サーバー上のファイルは、手元にあるファイルよりも更に変更が加えられた新しいバージョンになっているかも知れません。少なくとも、一日の始めに、開発に取りかかるその前に、一度は**アップデート (update)** を行うようにしましょう。

手元のファイルをアップデートするには、ターミナル上で、以下のコマンドを実行します。

```
$ svn update .
```

これで、カレントディレクトリ下 (サブディレクトリ下も) のファイルはすべて最新の状態に更新され、更に追加されたファイルなどもダウンロードされます。このコマンドは、基本的にはチェックアウトしたディレクトリ、すなわち boeboe ディレクトリ下で行うようにすると良いでしょう (プロジェクトの規模が大きくなってくると処理に時間がかかるようにはなりますが…)。

また、コミットをしようとして、エラーになる場合でも、一旦アップデートを行ってからコミットし直せば、たいていの場合はうまくいくはずです。

### ファイルを新規に追加する

ファイルを新たに追加した場合、そのことをサーバー上の Subversion リポジトリに通知する必要があります。この操作のことを**追加 (add)** と言います。追加を行うには、ターミナル上で、以下のコマンドを実行します。

```
$ svn add ファイル名
```

ファイル名はワイルドカードでも構いません。その場合、まだ追加されていないファイルだけが選択されます。

追加の際にはコメントは求められません。いずれにせよ、その後更にコミット操作が必要になり、その際にコメントを記述するべきです。
